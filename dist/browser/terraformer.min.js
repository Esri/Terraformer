(function(e,t){typeof module=="object"&&typeof module.exports=="object"?exports=module.exports=t():typeof define=="function"&&define.amd?define(t):e.Terraformer=t(),typeof jasmine=="object"&&(typeof Terraformer===undefined&&(e.Terraformer={}),e.Terraformer=t())})(this,function(){function o(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function u(e,t){t=t||{};var n=Object.keys(t);for(var r in n)e[n[r]]=t[n[r]];return e}function a(e){switch(e.type){case"Point":return[e.coordinates[0],e.coordinates[1],e.coordinates[0],e.coordinates[1]];case"MultiPoint":return l(e.coordinates);case"LineString":return l(e.coordinates);case"MultiLineString":return f(e.coordinates);case"Polygon":return l(e.coordinates[0]);case"MultiPolygon":return f(e.coordinates);case"Feature":return a(e.geometry);case"FeatureCollection":return c(e);case"GeometryCollection":return h(e);default:throw new Error("Unknown type: "+e.type)}}function f(e){var t=[],n;for(var r=e.length-1;r>=0;r--)typeof e[r][0]=="number"?(n=l(e),t.push([n[0],n[1]]),t.push([n[2],n[3]])):typeof e[r][0]=="object"&&(n=f(e[r]),t.push([n[0],n[1]]),t.push([n[2],n[3]]));return l(t)}function l(e){var t,n,r,i;for(var s=e.length-1;s>=0;s--){var o=e[s],u=o[0],a=o[1];t===undefined?t=u:u<t&&(t=u),r===undefined?r=a:a<r&&(r=a),n===undefined?n=u:u>n&&(n=u),i===undefined?i=a:a>i&&(i=a)}return[t,r,n,i]}function c(e){var t=[],n;for(var r=e.features.length-1;r>=0;r--)n=a(e.features[r].geometry),t.push([n[0],n[1]]),t.push([n[2],n[3]]);return l(t)}function h(e){var t=[],n;for(var r=e.geometries.length-1;r>=0;r--)n=a(e.geometries[r]),t.push([n[0],n[1]]),t.push([n[2],n[3]]);return l(t)}function p(e){return e*n}function d(e){return e*r}function v(e,t){for(var n=0;n<e.geometries.length;n++)e.geometries[n].geometry=g(e.features[n].geometry,t);return e}function m(e,t){for(var n=0;n<e.features.length;n++)e.features[n].geometry=g(e.features[n].geometry,t);return e}function g(e,t){for(var n=0;n<e.length;n++)typeof e[n][0]=="number"&&(e[n]=t(e[n])),typeof e[n]=="object"&&(e[n]=g(e[n],t));return e}function y(e){var n=e[0],r=e[1];return[p(n/t)-Math.floor((p(n/t)+180)/360)*360,p(Math.PI/2-2*Math.atan(Math.exp(-1*r/t)))]}function b(e){var n=e[0],r=Math.max(Math.min(e[1],89.99999),-89.99999);return[d(n)*t,t/2*Math.log((1+Math.sin(d(r)))/(1-Math.sin(d(r))))]}function w(e,t){return e.type==="Point"?e.coordinates=t(e.coordinates):e.type==="Feature"?e.geometry=w(e,t):e.type==="FeatureCollection"?e.features=m(e,t):e.type==="GeometryCollection"?e.geometries=v(e,t):e.coordinates=g(e.coordinates,t),t===b&&(e.crs=i),t===y&&delete e.crs,e}function E(e){return w(e,b)}function S(e){return w(e,y)}function x(e,t){return e<t?-1:e>t?1:0}function T(e,t,n){return x((t[0]-e[0])*(n[1]-e[1])-(n[0]-e[0])*(t[1]-e[1]),0)}function N(e,t){var n=t[0]-e[0],r=t[1]-e[1];return n*n+r*r}function C(e,t){var n=t;for(var r in e){var i=T(t,n,e[r]);if(i===-1||i===0&&N(t,e[r])>N(t,n))n=e[r]}return n}function k(e){function t(e,t){return e[0]-t[0]>e[1]-t[1]?1:e[0]-t[0]<e[1]-t[1]?-1:0}if(e.length===0)return[];if(e.length===1)return e;var n=[e.sort(t)[0]];for(var r=0;r<n.length;r++){var i=C(e,n[r]);i!==n[0]&&n.push(i)}return n}function L(e,t){var n=!1;for(var r=-1,i=e.length,s=i-1;++r<i;s=r)(e[r][1]<=t[1]&&t[1]<e[s][1]||e[s][1]<=t[1]&&t[1]<e[r][1])&&t[0]<(e[s][0]-e[r][0])*(t[1]-e[r][1])/(e[s][1]-e[r][1])+e[r][0]&&(n=!0);return n}function O(e){if(e)switch(e.type){case"Point":return new M(e);case"MultiPoint":return new _(e);case"LineString":return new D(e);case"MultiLineString":return new P(e);case"Polygon":return new H(e);case"MultiPolygon":return new B(e);case"Feature":return new j(e);case"FeatureCollection":return new F(e);case"GeometryCollection":return new I(e);default:throw new Error("Unknown type: "+e.type)}}function M(e){var t=Array.prototype.slice.call(arguments);if(e&&e.type==="Point"&&e.coordinates)o(this,e);else if(e&&Array.isArray(e))this.coordinates=e;else{if(!(t.length>=2))throw"Terraformer: invalid input for Terraformer.Point";this.coordinates=t}this.type="Point",this.__defineGetter__("bbox",function(){return a(this)})}function _(e){if(e&&e.type==="MultiPoint"&&e.coordinates)o(this,e);else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.MultiPoint";this.coordinates=e}this.type="MultiPoint",this.__defineGetter__("bbox",function(){return a(this)}),this.__defineGetter__("length",function(){return this.coordinates?this.coordinates.length:0})}function D(e){if(e&&e.type==="LineString"&&e.coordinates)o(this,e);else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.LineString";this.coordinates=e}this.type="LineString",this.__defineGetter__("bbox",function(){return a(this)})}function P(e){if(e&&e.type==="MultiLineString"&&e.coordinates)o(this,e);else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.MultiLineString";this.coordinates=e}this.type="MultiLineString",this.__defineGetter__("bbox",function(){return a(this)}),this.__defineGetter__("length",function(){return this.coordinates?this.coordinates.length:0})}function H(e){if(e&&e.type==="Polygon"&&e.coordinates)o(this,e);else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.Polygon";this.coordinates=e}this.type="Polygon",this.__defineGetter__("bbox",function(){return a(this)})}function B(e){if(e&&e.type==="MultiPolygon"&&e.coordinates)o(this,e);else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.MultiPolygon";this.coordinates=e}this.type="MultiPolygon",this.__defineGetter__("bbox",function(){return a(this)}),this.__defineGetter__("length",function(){return this.coordinates?this.coordinates.length:0})}function j(e){if(e&&e.type==="Feature"&&e.geometry)o(this,e);else{if(!(e&&e.type&&e.coordinates))throw"Terraformer: invalid input for Terraformer.Feature";this.geometry=e}this.type="Feature",this.__defineGetter__("bbox",function(){return a(this)})}function F(e){if(e&&e.type==="FeatureCollection"&&e.features)o(this,e);else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.FeatureCollection";this.features=e}this.type="FeatureCollection",this.__defineGetter__("length",function(){return this.features?this.features.length:0}),this.__defineGetter__("bbox",function(){return a(this)})}function I(e){if(e&&e.type==="GeometryCollection"&&e.geometries)o(this,e);else if(Array.isArray(e))this.geometries=e;else{if(!e.coordinates||!e.type)throw"Terraformer: invalid input for Terraformer.GeometryCollection";this.type="GeometryCollection",this.geometries=[e]}this.type="GeometryCollection",this.__defineGetter__("length",function(){return this.geometries?this.geometries.length:0}),this.__defineGetter__("bbox",function(){return a(this)})}function q(e,t,n){var r=b(e),i=n||64,s=t||250,o={type:"Polygon",coordinates:[[]]};for(var u=1;u<=i;u++){var a=u*(360/i)*Math.PI/180;o.coordinates[0].push([r[0]+s*Math.cos(a),r[1]+s*Math.sin(a)])}return S(o)}function R(e,t,n){var r=n||64,i=t||250;if(!e||e.length<2||!i||!r)throw new Error("Terraformer: missing parameter for Terraformer.Circle");o(this,new j({type:"Feature",geometry:q(e,i,r),properties:{radius:i,center:e,steps:r}})),this.__defineGetter__("bbox",function(){return a(this)}),this.__defineGetter__("radius",function(){return this.properties.radius}),this.__defineSetter__("radius",function(e){this.properties.radius=e,this.recalculate()}),this.__defineGetter__("steps",function(){return this.properties.steps}),this.__defineSetter__("steps",function(e){this.properties.steps=e,this.recalculate()}),this.__defineGetter__("center",function(){return this.properties.center}),this.__defineSetter__("center",function(e){this.properties.center=e,this.recalculate()})}var e={},t=6378137,n=57.29577951308232,r=.017453292519943,i={type:"link",properties:{href:"http://spatialreference.org/ref/sr-org/6928/ogcwkt/",type:"ogcwkt"}},s={type:"link",properties:{href:"http://spatialreference.org/ref/epsg/4326/ogcwkt/",type:"ogcwkt"}},A=["length"];return O.prototype={toMercator:function(){return E(this)},toGeographic:function(){return S(this)},convexHull:function(){var e=[],t,n;if(this.type==="Point")return this.coordinates&&this.coordinates.length>0?[this.coordinates]:[];if(this.type==="LineString"||this.type==="MultiPoint"){if(!(this.coordinates&&this.coordinates.length>0))return[];e=this.coordinates}else if(this.type==="Polygon"||this.type==="MultiLineString"){if(!(this.coordinates&&this.coordinates.length>0))return[];for(t=0;t<this.coordinates.length;t++)e=e.concat(this.coordinates[t])}else{if(this.type!=="MultiPolygon")throw new Error("Unable to get convex hull of "+this.type);if(!(this.coordinates&&this.coordinates.length>0))return[];for(t=0;t<this.coordinates.length;t++)for(n=0;n<this.coordinates[t].length;n++)e=e.concat(this.coordinates[t][n])}return k(e)},toJSON:function(){var e={};for(var t in this)this.hasOwnProperty(t)&&this[t]&&A.indexOf(t)&&(e[t]=this[t]);return e},toJson:function(){return JSON.stringify(this)}},M.prototype=new O,M.prototype.constructor=M,_.prototype=new O,_.prototype.constructor=_,_.prototype.forEach=function(e){for(var t=0;t<this.length;t++)e.apply(this,[this.coordinates[t],t,this.coordinates]);return this},_.prototype.addPoint=function(e){return this.coordinates.push(e),this},_.prototype.insertPoint=function(e,t){return this.coordinates.splice(t,0,e),this},_.prototype.removePoint=function(e){return typeof e=="number"?this.coordinates.splice(e,1):this.coordinates.splice(this.coordinates.indexOf(e),1),this},D.prototype=new O,D.prototype.constructor=D,D.prototype.addVertex=function(e){return this.coordinates.push(e),this},D.prototype.insertVertex=function(e,t){return this.coordinates.splice(t,0,e),this},D.prototype.removeVertex=function(e){return this.coordinates.splice(e,1),this},P.prototype=new O,P.prototype.constructor=P,P.prototype.forEach=function(e){for(var t=0;t<this.coordinates.length;t++)e.apply(this,[this.coordinates[t],t,this.coordinates])},H.prototype=new O,H.prototype.constructor=H,H.prototype.addVertex=function(e){return this.coordinates[0].push(e),this},H.prototype.insertVertex=function(e,t){return this.coordinates[0].splice(t,0,e),this},H.prototype.removeVertex=function(e){return this.coordinates[0].splice(e,1),this},H.prototype.contains=function(e){if(e.type!=="Point")throw new Error("Only points are supported");if(e.coordinates&&e.coordinates.length){if(this.coordinates&&this.coordinates.length===1)return L(this.coordinates[0],e.coordinates);if(L(this.coordinates[0],e.coordinates)){for(var t=1;t<this.coordinates.length;t++)if(L(this.coordinates[t],e.coordinates))return!1;return!0}return!1}},B.prototype=new O,B.prototype.constructor=B,B.prototype.forEach=function(e){for(var t=0;t<this.coordinates.length;t++)e.apply(this,[this.coordinates[t],t,this.coordinates])},j.prototype=new O,j.prototype.constructor=j,F.prototype=new O,F.prototype.constructor=F,F.prototype.forEach=function(e){for(var t=0;t<this.features.length;t++)e.apply(this,[this.features[t],t,this.features])},F.prototype.get=function(e){var t;return this.forEach(function(n){console.log(n.id,e),n.id===e&&(t=n)}),t},I.prototype=new O,I.prototype.constructor=I,I.prototype.forEach=function(e){for(var t=0;t<this.geometries.length;t++)e.apply(this,[this.geometries[t],t,this.geometries])},R.prototype=new O,R.prototype.constructor=R,R.prototype.recalculate=function(){return this.geometry=q(this.center,this.radius,this.steps),this},e.Primitive=O,e.Point=M,e.MultiPoint=_,e.LineString=D,e.MultiLineString=P,e.Polygon=H,e.MultiPolygon=B,e.Feature=j,e.FeatureCollection=F,e.GeometryCollection=I,e.Circle=R,e.toMercator=E,e.toGeographic=S,e.Tools={},e.Tools.positionToMercator=b,e.Tools.positionToGeographic=y,e.Tools.applyConverter=w,e.Tools.toMercator=E,e.Tools.toGeographic=S,e.Tools.createCircle=q,e.Tools.calculateBounds=a,e.Tools.coordinatesContainPoint=L,e.Tools.convexHull=k,e.MercatorCRS=i,e.GeographicCRS=s,e});