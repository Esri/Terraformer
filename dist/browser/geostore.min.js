(function(e,t){typeof module=="object"&&typeof module.exports=="object"&&(exports=module.exports=t()),typeof define=="function"&&define.amd&&define(["terraformer/terraformer"],t),typeof e.navigator=="object"&&(typeof e.Terraformer=="undefined"&&(e.Terraformer={}),e.Terraformer.GeoStore=t().GeoStore)})(this,function(){function n(e,t){var n=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return t.apply(e,n||arguments)}}function r(e){if(!e.store||!e.index)throw new Error("Terraformer.GeoStore requires an instace of a Terraformer.Store and a instance of Terraformer.RTree");this.deferred=e.deferred?e.deferred:t.Deferred,this.index=e.index,this.store=e.store;var n=e.data||[];while(n.length)this.add(n.shift())}var e={},t;typeof this.navigator=="object"&&(t=this.Terraformer),typeof module=="object"&&typeof module.exports=="object"&&(t=require("terraformer")),arguments[0]&&typeof define=="function"&&define.amd&&(t=arguments[0]),arguments[0]&&typeof define=="function"&&define.amd&&(this.Terraformer=arguments[0]);if(typeof module=="object"&&typeof module.exports=="object")var t=require("terraformer");return r.prototype.add=function(e,n){var r=new this.deferred,i;n&&r.then(function(e){n(null,e)},function(e){n(e,null)});if(!e.type.match(/Feature/))throw new Error("Terraform.GeoStore : only Features and FeatureCollections are supported");if(!e.id)throw new Error("Terraform.GeoStore : Feature does not have an id property");if(e.type==="FeatureCollection")for(var s=0;s<e.features.length;s++)i=e.features[s]?e.features[s]:t.Tools.calculateBounds(e.features[s]),this.index.insert({x:i[0],y:i[1],w:Math.abs(i[0]-i[2]),h:Math.abs(i[1]-i[3])},e.features[s].id);else i=e.bbox?e.bbox:t.Tools.calculateBounds(e),this.index.insert({x:i[0],y:i[1],w:Math.abs(i[0]-i[2]),h:Math.abs(i[1]-i[3])},e.id);return this.store.add(e,r),r},r.prototype.remove=function(e,t){var n=new this.deferred;return t&&n.then(function(e){t(null,e)},function(e){t(e,null)}),this.index.remove(e,n),this.store.remove(e,n),n},r.prototype._test=function(e,r,i){var s=new this.deferred;i&&s.then(function(e){i(null,e)},function(e){i(e,null)});var o=t.Tools.calculateEnvelope(r);return this.index.search(o).then(n(this,function(n){var i=[],o=0,u=function(u){o++;var a=new t.Primitive(u);a[e]&&a[e](r)&&i.push(a),o>=n.length&&s.resolve(i)};for(var a=0;a<n.length;a++)this.get(n[a]).then(u)})),s},r.prototype.within=function(e,t){console.error("`within` is not implemented")},r.prototype.intersects=function(e,t){console.error("`intersects` is not implemented")},r.prototype.contains=function(e,t){return console.warn("contains will be depricated soon when `within` and `intersects` are complete"),this._test("contains",e,t)},r.prototype.update=function(e,n){var r=new this.deferred;n&&r.then(function(e){n(null,e)},function(e){n(e,null)});if(e.type!=="Feature")throw new Error("Terraform.GeoStore : only Features and FeatureCollections are supported");if(!e.id)throw new Error("Terraform.GeoStore : Feature does not have an id property");this.index.remove(e.id);var i=e.bbox?e.bbox:t.Tools.calculateBounds(e);return this.index.insert({x:i[0],y:i[1],w:Math.abs(i[0]-i[2]),h:Math.abs(i[1]-i[3])},e.id),this.store.update(e,r),r},r.prototype.get=function(e,t){var n=new this.deferred;return t&&n.then(function(e){t(null,e)},function(e){t(e,null)}),this.store.get(e,n),n},e.GeoStore=r,e});