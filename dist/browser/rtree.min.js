(function(e,t){typeof module=="object"&&typeof module.exports=="object"&&(exports=module.exports=t()),typeof define=="function"&&define.amd&&define(["terraformer/terraformer"],t),typeof e.Terraformer=="undefined"&&(e.Terraformer={}),e.Terraformer.RTree=t().RTree})(this,function(){var e={},t;typeof this.navigator=="object"&&(t=this.Terraformer),typeof module=="object"&&typeof module.exports=="object"&&(t=require("terraformer")),arguments[0]&&typeof define=="function"&&define.amd&&(t=arguments[0]);var n=function(e){var r=3,i=6;isNaN(e)||(r=Math.floor(e/2),i=e);var s={x:0,y:0,w:0,h:0,id:"root",nodes:[]},o=function(){var e={};return function(t){var n=0;return t in e?n=e[t]++:e[t]=0,t+"_"+n}}();n.Rectangle.squarified_ratio=function(e,t,n){var r=(e+t)/2,i=e*t,s=i/(r*r);return i*n/s};var u=function(e,t,i){var s=[],o=[],u=[],a=1;if(!e||!n.Rectangle.overlap_rectangle(e,i))return u;var f={x:e.x,y:e.y,w:e.w,h:e.h,target:t};o.push(i.nodes.length),s.push(i);do{var l=s.pop(),c=o.pop()-1;if("target"in f)while(c>=0){var h=l.nodes[c];if(n.Rectangle.overlap_rectangle(f,h)){if(f.target&&"leaf"in h&&h.leaf===f.target||!f.target&&("leaf"in h||n.Rectangle.contains_rectangle(h,f))){"nodes"in h?(u=p(h,!0,[],h),l.nodes.splice(c,1)):u=l.nodes.splice(c,1),n.Rectangle.make_MBR(l.nodes,l),delete f.target,l.nodes.length<r&&(f.nodes=p(l,!0,[],l));break}"nodes"in h&&(a+=1,o.push(c),s.push(l),l=h,c=h.nodes.length)}c-=1}else if("nodes"in f){l.nodes.splice(c+1,1),l.nodes.length>0&&n.Rectangle.make_MBR(l.nodes,l);for(var v=0;v<f.nodes.length;v++)d(f.nodes[v],l);f.nodes.length=0,s.length===0&&l.nodes.length<=1?(f.nodes=p(l,!0,f.nodes,l),l.nodes.length=0,s.push(l),o.push(1)):s.length>0&&l.nodes.length<r?(f.nodes=p(l,!0,f.nodes,l),l.nodes.length=0):delete f.nodes}else n.Rectangle.make_MBR(l.nodes,l);a-=1}while(s.length>0);return u},a=function(e,t){var r=-1,i=[],s,o=function(e,t){return function(n){e._attach_data(t,n)}};i.push(t);var u=t.nodes;do{r!==-1&&(i.push(u[r]),u=u[r].nodes,r=-1);for(var a=u.length-1;a>=0;a--){var f=u[a];if("leaf"in f){r=-1;break}var l=n.Rectangle.squarified_ratio(f.w,f.h,f.nodes.length+1),c=Math.max(f.x+f.w,e.x+e.w)-Math.min(f.x,e.x),h=Math.max(f.y+f.h,e.y+e.h)-Math.min(f.y,e.y),p=n.Rectangle.squarified_ratio(c,h,f.nodes.length+2);if(r<0||Math.abs(p-l)<s)s=Math.abs(p-l),r=a}}while(r!==-1);return i},f=function(e){var t=c(e);while(e.length>0)l(e,t[0],t[1]);return t},l=function(e,t,i){var s=n.Rectangle.squarified_ratio(t.w,t.h,t.nodes.length+1),o=n.Rectangle.squarified_ratio(i.w,i.h,i.nodes.length+1),u,a,f;for(var l=e.length-1;l>=0;l--){var c=e[l],h={};h.x=Math.min(t.x,c.x),h.y=Math.min(t.y,c.y),h.w=Math.max(t.x+t.w,c.x+c.w)-h.x,h.h=Math.max(t.y+t.h,c.y+c.h)-h.y;var p=Math.abs(n.Rectangle.squarified_ratio(h.w,h.h,t.nodes.length+2)-s),d={};d.x=Math.min(i.x,c.x),d.y=Math.min(i.y,c.y),d.w=Math.max(i.x+i.w,c.x+c.w)-d.x,d.h=Math.max(i.y+i.h,c.y+c.h)-d.y;var v=Math.abs(n.Rectangle.squarified_ratio(d.w,d.h,i.nodes.length+2)-o);if(!a||!u||Math.abs(v-p)<u)a=l,u=Math.abs(v-p),f=v<p?i:t}var m=e.splice(a,1)[0];t.nodes.length+e.length+1<=r?(t.nodes.push(m),n.Rectangle.expand_rectangle(t,m)):i.nodes.length+e.length+1<=r?(i.nodes.push(m),n.Rectangle.expand_rectangle(i,m)):(f.nodes.push(m),n.Rectangle.expand_rectangle(f,m))},c=function(e){var t=e.length-1,n=0,r=e.length-1,i=0,s,o;for(var u=e.length-2;u>=0;u--){var a=e[u];a.x>e[n].x?n=u:a.x+a.w<e[t].x+e[t].w&&(t=u),a.y>e[i].y?i=u:a.y+a.h<e[r].y+e[r].h&&(r=u)}var f=Math.abs(e[t].x+e[t].w-e[n].x),l=Math.abs(e[r].y+e[r].h-e[i].y);return f>l?t>n?(s=e.splice(t,1)[0],o=e.splice(n,1)[0]):(o=e.splice(n,1)[0],s=e.splice(t,1)[0]):r>i?(s=e.splice(r,1)[0],o=e.splice(i,1)[0]):(o=e.splice(i,1)[0],s=e.splice(r,1)[0]),[{x:s.x,y:s.y,w:s.w,h:s.h,nodes:[s]},{x:o.x,y:o.y,w:o.w,h:o.h,nodes:[o]}]},h=function(e,t){return e.nodes=t.nodes,e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e},p=function(e,t,r,i){var s=[];if(!n.Rectangle.overlap_rectangle(e,i))return r;var o=function(e,t){return function(n){e._attach_data(t,n)}};s.push(i.nodes);do{var u=s.pop();for(var a=u.length-1;a>=0;a--){var f=u[a];n.Rectangle.overlap_rectangle(e,f)&&("nodes"in f?s.push(f.nodes):"leaf"in f&&(t?r.push(f):r.push(f.leaf)))}}while(s.length>0);return r},d=function(e,t){var r;if(t.nodes.length===0){t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,t.nodes.push(e);return}var s=a(e,t),o=e;do{if(r&&"nodes"in r&&r.nodes.length===0){var u=r;r=s.pop();for(var l=0;l<r.nodes.length;l++)if(r.nodes[l]===u||r.nodes[l].nodes.length===0){r.nodes.splice(l,1);break}}else r=s.pop();if("leaf"in o||"nodes"in o||Array.isArray(o)){if(Array.isArray(o)){for(var c=0;c<o.length;c++)n.Rectangle.expand_rectangle(r,o[c]);r.nodes=r.nodes.concat(o)}else n.Rectangle.expand_rectangle(r,o),r.nodes.push(o);if(r.nodes.length<=i)o={x:r.x,y:r.y,w:r.w,h:r.h};else{var h=f(r.nodes);o=h,s.length<1&&(r.nodes.push(h[0]),s.push(r),o=h[1])}}else n.Rectangle.expand_rectangle(r,o),o={x:r.x,y:r.y,w:r.w,h:r.h}}while(s.length>0)};this.serialize=function(e){var n=new t.Deferred;return e&&n.then(function(t){e(null,t)},function(t){e(t,null)}),n.resolve(s),n},this.deserialize=function(e,n,r){var i=Array.prototype.slice.call(arguments),o=new t.Deferred;switch(i.length){case 1:n=s;break;case 2:typeof i[1]=="function"&&(n=s,r=i[1])}return r&&o.then(function(e){r(null,e)},function(e){r(e,null)}),o.resolve(h(n,e)),o},this.search=function(e,n){var r;if(e.type){var i=t.Tools.calculateBounds(e);r={x:i[0],y:i[1],w:Math.abs(i[0]-i[2]),h:Math.abs(i[1]-i[3])}}else r=e;var o=new t.Deferred,u=[r,!1,[],s];if(r===undefined)throw"Wrong number of arguments. RT.Search requires at least a bounding rectangle.";return n&&o.then(function(e){n(null,e)},function(e){n(e,null)}),o.resolve(p.apply(this,u)),o},this.toJSON=function(e,t){var r=[],i=[],u={},a=3,f=1,l="";if(e&&!n.Rectangle.overlap_rectangle(e,s))return"";t?(a+=4,i.push(t.nodes.length),r.push(t.nodes),l+="var main_tree = {x:"+t.x.toFixed()+",y:"+t.y.toFixed()+",w:"+t.w.toFixed()+",h:"+t.h.toFixed()+",nodes:["):(i.push(s.nodes.length),r.push(s.nodes),l+="var main_tree = {x:"+s.x.toFixed()+",y:"+s.y.toFixed()+",w:"+s.w.toFixed()+",h:"+s.h.toFixed()+",nodes:[");do{var c=r.pop(),h=i.pop()-1;h>=0&&h<c.length-1&&(l+=",");while(h>=0){var p=c[h];if(!e||n.Rectangle.overlap_rectangle(e,p))if(p.nodes)if(f>=a){var d=u.length,v=o("saved_subtree");l+="{x:"+p.x.toFixed()+",y:"+p.y.toFixed()+",w:"+p.w.toFixed()+",h:"+p.h.toFixed()+",load:'"+v+".js'}",u[v]=this.toJSON(e,p),h>0&&(l+=",")}else l+="{x:"+p.x.toFixed()+",y:"+p.y.toFixed()+",w:"+p.w.toFixed()+",h:"+p.h.toFixed()+",nodes:[",f+=1,i.push(h),r.push(c),c=p.nodes,h=p.nodes.length;else if(p.leaf){var m=p.leaf.toJSON?p.leaf.toJSON():JSON.stringify(p.leaf);l+="{x:"+p.x.toFixed()+",y:"+p.y.toFixed()+",w:"+p.w.toFixed()+",h:"+p.h.toFixed()+",leaf:"+m+"}",h>0&&(l+=",")}else p.load&&(l+="{x:"+p.x.toFixed()+",y:"+p.y.toFixed()+",w:"+p.w.toFixed()+",h:"+p.h.toFixed()+",load:'"+p.load+"'}",h>0&&(l+=","));h-=1}h<0&&(l+="]}",f-=1)}while(r.length>0);l+=";";for(var g in u)l+="\nvar "+g+" = function(){"+u[g]+" return(main_tree);};";return l},this.remove=function(e,n,r){var i=Array.prototype.slice.call(arguments),o;if(i[0].type){var a=t.Tools.calculateBounds(e);i[0]={x:a[0],y:a[1],w:Math.abs(a[0]-a[2]),h:Math.abs(a[1]-a[3])}}var f=new t.Deferred;if(i.length<1)throw"Wrong number of arguments. RT.remove requires at least a bounding rectangle or GeoJSON.";switch(i.length){case 1:o=!1;break;case 2:typeof i[1]=="function"?(o=!1,r=i[1]):o=i[1]}r&&f.then(function(e){r(null,e)},function(e){r(e,null)}),i=[i[0],o,s];if(i[1]===!1){var l=0,c=[];do l=c.length,c=c.concat(u.apply(this,i));while(l!==c.length);f.resolve(c)}else f.resolve(u.apply(this,i));return f},this.insert=function(e,n,r){var i;if(e.type){var o=t.Tools.calculateBounds(e);i={x:o[0],y:o[1],w:Math.abs(o[0]-o[2]),h:Math.abs(o[1]-o[3])}}else i=e;var u=new t.Deferred;if(arguments.length<2)throw"Wrong number of arguments. RT.Insert requires at least a bounding rectangle or GeoJSON and an object.";return r&&u.then(function(e){r(null,e)},function(e){r(e,null)}),u.resolve(d({x:i.x,y:i.y,w:i.w,h:i.h,leaf:n},s)),u}};return n.Rectangle=function(e,t,n,r){var i,s,o,u,a,f;e.x?(i=e.x,o=e.y,e.w!==0&&!e.w&&e.x2?(a=e.x2-e.x,f=e.y2-e.y):(a=e.w,f=e.h),s=i+a,u=o+f):(i=e,o=t,a=n,f=r,s=i+a,u=o+f),this.x1=this.x=function(){return i},this.y1=this.y=function(){return o},this.x2=function(){return s},this.y2=function(){return u},this.w=function(){return a},this.h=function(){return f},this.toJSON=function(){return'{"x":'+i.toString()+', "y":'+o.toString()+', "w":'+a.toString()+', "h":'+f.toString()+"}"},this.overlap=function(e){return this.x()<e.x2()&&this.x2()>e.x()&&this.y()<e.y2()&&this.y2()>e.y()},this.expand=function(e){var t=Math.min(this.x(),e.x()),n=Math.min(this.y(),e.y());return a=Math.max(this.x2(),e.x2())-t,f=Math.max(this.y2(),e.y2())-n,i=t,o=n,this},this.setRect=function(e,t,n,r){var i,s,o,u,a,f;e.x?(i=e.x,o=e.y,e.w!==0&&!e.w&&e.x2?(a=e.x2-e.x,f=e.y2-e.y):(a=e.w,f=e.h),s=i+a,u=o+f):(i=e,o=t,a=n,f=r,s=i+a,u=o+f)}},n.Rectangle.overlap_rectangle=function(e,t){return e.x<t.x+t.w&&e.x+e.w>t.x&&e.y<t.y+t.h&&e.y+e.h>t.y},n.Rectangle.contains_rectangle=function(e,t){return e.x+e.w<=t.x+t.w&&e.x>=t.x&&e.y+e.h<=t.y+t.h&&e.y>=t.y},n.Rectangle.expand_rectangle=function(e,t){var n,r;return e.x<t.x?n=e.x:n=t.x,e.y<t.y?r=e.y:r=t.y,e.x+e.w>t.x+t.w?e.w=e.x+e.w-n:e.w=t.x+t.w-n,e.y+e.h>t.y+t.h?e.h=e.y+e.h-r:e.h=t.y+t.h-r,e.x=n,e.y=r,e},n.Rectangle.make_MBR=function(e,t){if(e.length<1)return{x:0,y:0,w:0,h:0};t?(t.x=e[0].x,t.y=e[0].y,t.w=e[0].w,t.h=e[0].h):t={x:e[0].x,y:e[0].y,w:e[0].w,h:e[0].h};for(var r=e.length-1;r>0;r--)n.Rectangle.expand_rectangle(t,e[r]);return t},e.RTree=n,e});